
Ext.ux.ToolbarReorderer=Ext.extend(Ext.ux.Reorderer,{init:function(toolbar){this.buttonXCache={};toolbar.on({scope:this,add:function(toolbar,item){this.createIfReorderable(item);}});Ext.ux.ToolbarReorderer.superclass.init.apply(this,arguments);},createItemDD:function(button){if(button.dd!=undefined){return;}
var el=button.getEl(),id=el.id,tbar=this.target,me=this;button.dd=new Ext.dd.DD(el,undefined,{isTarget:false});var menuDisabler=function(){return false;};Ext.apply(button.dd,{b4StartDrag:function(){this.startPosition=el.getXY();this.startZIndex=el.getStyle('zIndex');el.setStyle('zIndex',10000);button.suspendEvents();if(button.menu){button.menu.on('beforeshow',menuDisabler,me);}},startDrag:function(){this.constrainTo(tbar.getEl());this.setYConstraint(0,0,0);},onDrag:function(e){var buttonX=el.getXY()[0],deltaX=buttonX-this.startPosition[0],items=tbar.items.items,oldIndex=items.indexOf(button),newIndex;for(var index=0;index<items.length;index++){var item=items[index];if(item.reorderable&&item.id!=button.id){var box=item.getEl().getBox(),midpoint=(me.buttonXCache[item.id]||box.x)+(box.width/2),movedLeft=oldIndex>index&&deltaX<0&&buttonX<midpoint,movedRight=oldIndex<index&&deltaX>0&&(buttonX+el.getWidth())>midpoint;if(movedLeft||movedRight){me[movedLeft?'onMovedLeft':'onMovedRight'](button,index,oldIndex);break;}}}},endDrag:function(){me.updateButtonXCache();el.moveTo(me.buttonXCache[button.id],el.getY(),{duration:me.animationDuration,scope:this,callback:function(){button.resumeEvents();if(button.menu){button.menu.un('beforeshow',menuDisabler,me);}
tbar.fireEvent('reordered',button,tbar);}});el.setStyle('zIndex',this.startZIndex);}});},onMovedLeft:function(item,newIndex,oldIndex){var tbar=this.target,items=tbar.items.items;if(newIndex!=undefined&&newIndex!=oldIndex){tbar.remove(item,false);tbar.insert(newIndex,item);this.updateButtonXCache();for(var index=0;index<items.length;index++){var obj=items[index],newX=this.buttonXCache[obj.id];if(item==obj){item.dd.startPosition[0]=newX;}else{var el=obj.getEl();el.moveTo(newX,el.getY(),{duration:this.animationDuration});}}}},onMovedRight:function(item,newIndex,oldIndex){this.onMovedLeft.apply(this,arguments);},updateButtonXCache:function(){var tbar=this.target,items=tbar.items,totalX=tbar.getEl().getBox(true).x;items.each(function(item){this.buttonXCache[item.id]=totalX;totalX+=item.getEl().getWidth();},this);}});