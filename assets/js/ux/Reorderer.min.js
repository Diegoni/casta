
Ext.ux.Reorderer=Ext.extend(Object,{defaults:{animate:true,animationDuration:0.2,defaultReorderable:false},constructor:function(config){Ext.apply(this,config||{},this.defaults);},init:function(target){this.target=target;this.initEvents();var items=this.getItems(),length=items.length,i;for(i=0;i<length;i++){this.createIfReorderable(items[i]);}},reorder:function(mappings){var target=this.target;if(target.fireEvent('before-reorder',mappings,target,this)!==false){this.doReorder(mappings);target.fireEvent('reorder',mappings,target,this);}},doReorder:function(paramName){throw new Error("doReorder must be implemented in the Ext.ux.Reorderer subclass");},createItemDD:function(item){throw new Error("createItemDD must be implemented in the Ext.ux.Reorderer subclass");},createItemDD:function(button){var el=button.getEl(),id=el.id,tbar=this.target,me=this;button.dd=new Ext.dd.DD(el,undefined,{isTarget:false});button.dd.constrainTo(tbar.getEl());button.dd.setYConstraint(0,0,0);Ext.apply(button.dd,{b4StartDrag:function(){this.startPosition=el.getXY();this.startZIndex=el.getStyle('zIndex');el.setStyle('zIndex',10000);button.suspendEvents();},onDrag:function(e){var buttonX=el.getXY()[0],deltaX=buttonX-this.startPosition[0],items=tbar.items.items,oldIndex=items.indexOf(button),newIndex;for(var index=0;index<items.length;index++){var item=items[index];if(item.reorderable&&item.id!=button.id){var box=item.getEl().getBox(),midpoint=(me.buttonXCache[item.id]||box.x)+(box.width/2),movedLeft=oldIndex>index&&deltaX<0&&buttonX<midpoint,movedRight=oldIndex<index&&deltaX>0&&(buttonX+el.getWidth())>midpoint;if(movedLeft||movedRight){me[movedLeft?'onMovedLeft':'onMovedRight'](button,index,oldIndex);break;}}}},endDrag:function(){me.updateButtonXCache();el.moveTo(me.buttonXCache[button.id],undefined,{duration:me.animationDuration,scope:this,callback:function(){button.resumeEvents();tbar.fireEvent('reordered',button,tbar);}});el.setStyle('zIndex',this.startZIndex);}});},createIfReorderable:function(item){if(this.defaultReorderable&&item.reorderable==undefined){item.reorderable=true;}
if(item.reorderable&&!item.dd){if(item.rendered){this.createItemDD(item);}else{item.on('render',this.createItemDD.createDelegate(this,[item]),this,{single:true});}}},getItems:function(){return this.target.items.items;},initEvents:function(){this.target.addEvents('before-reorder','reorder');}});Ext.ux.HBoxReorderer=Ext.extend(Ext.ux.Reorderer,{init:function(container){this.buttonXCache={};container.on({scope:this,add:function(container,item){this.createIfReorderable(item);}});Ext.ux.HBoxReorderer.superclass.init.apply(this,arguments);},createItemDD:function(button){if(button.dd!=undefined){return;}
var el=button.getEl(),id=el.id,me=this,tbar=me.target;button.dd=new Ext.dd.DD(el,undefined,{isTarget:false});el.applyStyles({position:'absolute'});var menuDisabler=function(){return false;};Ext.apply(button.dd,{b4StartDrag:function(){this.startPosition=el.getXY();this.startZIndex=el.getStyle('zIndex');el.setStyle('zIndex',10000);button.suspendEvents();if(button.menu){button.menu.on('beforeshow',menuDisabler,me);}},startDrag:function(){this.constrainTo(tbar.getEl());this.setYConstraint(0,0,0);},onDrag:function(e){var buttonX=el.getXY()[0],deltaX=buttonX-this.startPosition[0],items=tbar.items.items,length=items.length,oldIndex=items.indexOf(button),newIndex,index,item;for(index=0;index<length;index++){item=items[index];if(item.reorderable&&item.id!=button.id){var box=item.getEl().getBox(),midpoint=(me.buttonXCache[item.id]||box.x)+(box.width/2),movedLeft=oldIndex>index&&deltaX<0&&buttonX<midpoint,movedRight=oldIndex<index&&deltaX>0&&(buttonX+el.getWidth())>midpoint;if(movedLeft||movedRight){me[movedLeft?'onMovedLeft':'onMovedRight'](button,index,oldIndex);break;}}}},endDrag:function(){me.updateButtonXCache();el.moveTo(me.buttonXCache[button.id],el.getY(),{duration:me.animationDuration,scope:this,callback:function(){button.resumeEvents();if(button.menu){button.menu.un('beforeshow',menuDisabler,me);}
tbar.fireEvent('reordered',button,tbar);}});el.setStyle('zIndex',this.startZIndex);}});},onMovedLeft:function(item,newIndex,oldIndex){var tbar=this.target,items=tbar.items.items,length=items.length,index;if(newIndex!=undefined&&newIndex!=oldIndex){tbar.remove(item,false);tbar.insert(newIndex,item);this.updateButtonXCache();for(index=0;index<length;index++){var obj=items[index],newX=this.buttonXCache[obj.id];if(item==obj){item.dd.startPosition[0]=newX;}else{var el=obj.getEl();el.moveTo(newX,el.getY(),{duration:this.animationDuration});}}}},onMovedRight:function(item,newIndex,oldIndex){this.onMovedLeft.apply(this,arguments);},updateButtonXCache:function(){var tbar=this.target,items=tbar.items,totalX=tbar.getEl().getBox(true).x;items.each(function(item){this.buttonXCache[item.id]=totalX;totalX+=item.getEl().getWidth();},this);}});