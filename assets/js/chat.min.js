
var chat_write=function(r,username,chatPanel,before)
{var tpl1='<div style="margin-right: 100px"><p class="bubble-user-received left">{3}</p>'+'<p class="message-data">'+"<span class='date'>[{0}]</span> De: <span class='from'>{1}</span> a <span class='to'>{2}</span></p></div>";var tpl2='<div style="margin-left: 100px"><p class="bubble-user-send right">{3}</p>'+'<p class="message-data">'+"<span class='date'>[{0}]</span> De: <span class='from'>{1}</span> a <span class='to'>{2}</span></p></div>";var tpl3='<div style="margin-right: 100px"><p class="bubble-group-send left">{3}</p>'+'<p class="message-data">'+"<span class='date'>[{0}]</span> De: <span class='from'>{1}</span> a <span class='to'>{4}</span></p></div>";var tpl4='<div style="margin-left: 100px"><p class="bubble-group-received right">{3}</p>'+'<p class="message-data">'+"<span class='date'>[{0}]</span> De: <span class='from'>{1}</span> a <span class='to'>{4}</span></p></div>";if(r.origen==null)
{r.origen=_s('[TODOS]');r.origennombre=_s('[TODOS]');}
if(r.destino==null)
{r.destino=_s('[TODOS]');r.destinonombre=_s('[TODOS]');}
var time=(Ext.app.renderDateShort(r.time)==Ext.app.renderDateShort(new Date()))?Ext.app.renderTime(r.time):Ext.app.renderDate(r.time);var origen=(r.origen!=_s('[TODOS]')&&r.origennombre!='')?String.format("<a href=# onclick=\"Ext.app.startPrivate('{0}',1, '{2}')\" title='{2}'>{1}</a>",r.origen,r.origennombre,r.origennombre.replace("'","\\'")):r.origen;var destino=(r.destino!=_s('[TODOS]')&&r.destinonombre!=null)?String.format("<a href=# onclick=\"Ext.app.startPrivate('{0}',1, '{2}')\" title='{2}'>{1}</a>",r.destino,r.destinonombre,r.destinonombre.replace("'","\\'")):r.destino;var grupo=(r.gruponombre!=null)?String.format("<a href=# onclick=\"Ext.app.startPrivate({0},2, '{2}')\" title='{2}'>{1}</a>",r.grupo,r.gruponombre,r.gruponombre.replace("'","\\'")):'';var tpl=(r.grupo==null)?((r.origen==username)?tpl1:tpl2):((r.origen==username)?tpl3:tpl4);var html=String.format(tpl,time,(r.origen==username)?_s('[yo]'):origen,(r.destino==username)?_s('[yo]'):destino,r.message,grupo);if(before){chatPanel.setValue(html+chatPanel.getValue());var oScroll=chatPanel.el.dom;chatPanel.el.scroll('t',oScroll.scrollHeight,true);}
else
{chatPanel.append(html);var oScroll=chatPanel.el.dom;var scrollDown=(oScroll.scrollHeight-oScroll.scrollTop<=oScroll.offsetHeight);if(!scrollDown){var sc=(oScroll.scrollTop>0)?oScroll.scrollTop:oScroll.scrollHeight;chatPanel.el.scroll('b',sc,true);}}}
var chat_clear=function(chatPanel){chatPanel.reset();}
var chat_controller=function(){var form_id="chat_global";var title=_s('Mensajes');var icon='iconoMensajesTab';if(Ext.app.tab==null)return;var old_tab=Ext.getCmp(form_id);if(old_tab!=null){return;}
if(Ext.app.showingmessage==null)
Ext.app.showingmessage=false;if(Ext.app.showingmessage===true)
return;Ext.app.showingmessage=true;Ext.app.execCmd({url:site_url('sys/mensaje/index'),fnok:function(){Ext.app.showingmessage=false;}});return;}
privChat=Ext.extend(Ext.Panel,{closable:true,iconCls:'icon-private-chat',layout:'border',cache:new Array(),lastMessageID:-1,updateInterval:1000,sendMessageGlobal:null,setRefresh:null,paramx:null,tid:0,mode:1,blink:false,firstId:-1,lastId:-1,listeners:{render:function(){this.repeatMessage();},destroy:function(){this.clearTime();},activate:function(){this.normalTitle();this.set_focus();},deactivate:function(){this.setBlink();}},set_focus:function(){this.txtMsg.focus();this.chatPanel.el.scroll('b',100000,true);},clearTime:function(){clearTimeout(this.tid);this.tid=0;},setBlink:function(){this.blink=true;},initComponent:function(){this.chatPanel=new Ext.form.DisplayField({border:true,region:'center',cls:'x-form-text',autoScroll:true});var t=this;var tbar=[{iconCls:'icon-chat-prev',handler:function(){t.callRefresh(t.tUser,t.firstId);}},'-',{iconCls:'icon-refresh',handler:function(){chat_clear(t.chatPanel);t.lastId=-1;t.firstId=-1;t.callRefresh(t.tUser);}},'-',{iconCls:'icon-clean',handler:function(){chat_clear(t.chatPanel);}}];if(this.mode==2){tbar[tbar.length]='-';tbar[tbar.length]={iconCls:'icon-delete',handler:function(){t.sendMessageGlobal(t.tUser,'delete');}}}
this.NorthPanel={border:false,margins:'2 2 2 2',region:'center',layout:'border',items:[this.chatPanel],tbar:tbar};this.txtMsg=new Ext.form.TextField({region:'center',enableKeyEvents:true});this.txtMsg.on('specialkey',function(o,e){if(e.getKey()==e.ENTER){this.sendMessage.call(this);}},this);this.btnSend=new Ext.Button({text:_s('Enviar'),iconCls:'icon-send-chat',flex:1,handler:this.sendMessage.createDelegate(this)});this.btnPanel={border:false,region:'east',margins:'0 0 0 2',width:75,layout:'vbox',layoutConfig:{padding:'0',align:'stretch'},items:[this.btnSend]};this.Spanel={region:'south',height:30,layout:'border',border:false,margins:'2 2 2 2',items:[this.txtMsg,this.btnPanel]};this.items=[this.NorthPanel,this.Spanel];privChat.superclass.initComponent.apply(this,arguments);;},sendMessage:function(){if(this.txtMsg.getValue()=='')
return false;this.sendMessageGlobal(this.tUser,this.txtMsg.getValue());this.txtMsg.setValue('');this.txtMsg.focus();},readMessages:function(msg){Ext.each(msg,function(r,i){if((r.id<this.firstId||this.firstId==-1)||(r.id>this.lastId||this.lastId==-1)){chat_write(r,this.username,this.chatPanel,r.id<this.firstId);if(r.id<this.firstId||this.firstId==-1)this.firstId=r.id;if(r.id>this.lastId||this.lastId==-1)this.lastId=r.id;if(r.origen!=this.username)
if(this.blink)
this.blinkTitle(r.origen);}},this);},repeatMessage:function(){return;clearTimeout(this.tid);this.tid=0;xx=function xx(){this.requestNewMessages.call(this);}
this.tid=xx.defer(this.updateInterval,this);},normalTitle:function(){this.setTitle(this.tUser);this.blink=false;this.chatPanel.el.scroll('b',100000,true);this.txtMsg.focus();},blinkTitle:function(p){this.setTitle(String.format("<span class='blink'>{0}</span>",this.tUser));}});